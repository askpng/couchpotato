---
# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json

name: fried-couchpotato
description: Light image with entertainment and game streaming capabilities.

base-image: quay.io/fedora/fedora-bootc
image-version: 43

modules:
  - from-file: phase/kernel-and-akmods.yml
  - from-file: phase/flex-launcher.yml
  - from-file: phase/xremap.yml

  - type: dnf
    repos:
      cleanup: true
      copr:
        - abn/throttled
        - ublue-os/bazzite
        - ferdiu/moonlight
      nonfree: rpmfusion
    install:
      install-weak-deps: false
      allow-erasing: true
      packages:
        # Graphics
        - ffmpeg
        - gstreamer1-plugin-dav1d
        - gstreamer1-plugin-libav
        - gstreamer1-plugins-base
        - gstreamer1-plugins-good
        - gstreamer1-plugins-good-qt
        - gstreamer1-plugins-bad-freeworld
        - gstreamer1-plugins-ugly
        - gstreamer1-vaapi
        - libavcodec-freeworld
        - libva
        - libva-intel-driver
        - intel-media-driver
        - mesa-va-drivers-freeworld
        - mesa-vulkan-drivers
        - pipewire-plugin-vulkan
        - vulkan-loader
        - vulkan-headers
        - vulkan-tools
        - xdg-user-dirs
        - xdg-utils
        # HTPC Packages
        ## Essentials
        - cage
        - cpuinfo
        - fish
        - grim
        - lm_sensors
        - lsb_release
        - moonlight-qt
        - pciutils
        - repo: copr:copr.fedorainfracloud.org:ublue-os:bazzite
          packages:
          - ryzenadj
        - seatd
        - s-tui
        - stress-ng
        - tuned
        - upower
        - usbutils
        ## Audio & Video
        - pipewire
        - pipewire-utils
        - pipewire-pulseaudio
        - pipewire-alsa
        - pulseaudio-utils
        - libva-utils
        - wireplumber
        ## Bluetooth & Controllers
        - bluez
        - evtest
        - python3-evdev
        - steam-devices
        ## CJK fonts
        - google-noto-serif-cjk-vf-fonts
        - google-noto-sans-mono-cjk-vf-fonts
        ## Internet & Management
        - chromium
        - cockpit
        - firewall-config
        - syncthing
        ## Undervolting & TDP limit for older Intel CPUs
        - throttled
        # Dependencies
        ## AppImage
        - fuse
        - ifuse
        ## Moonlight deps?
        - libxcb
        - qt6-qtwayland
        - xwayland-run

  - type: script
    scripts:
      - binaries.sh  
    snippets:
      # AppImages
      ## VacuumTube
      - curl -fLs https://github.com/shy1132/VacuumTube/releases/latest/download/VacuumTube-x86_64.AppImage -o /tmp/vacuumtube.AppImage
      - cp /tmp/vacuumtube.AppImage /usr/bin/vacuumtube.AppImage && chmod 0755 /usr/bin/vacuumtube.AppImage
      - ln -s /usr/bin/vacuumtube.AppImage /usr/bin/vacuumtube
      - rm /tmp/vacuumtube.AppImage
      - dnf clean all      

  - type: files
    files:
      - source: system
        destination: /
      - source: fried-couchpotato
        destination: /        

  - type: systemd
    user:
      enabled:
        - pipewire.service
        - pipewire-pulse.service
        - wireplumber.service
    system:
      # disabled:
        # - getty@$tty1.service # TODO, or README
      enabled:
        # Automatically logs in to the default user account
        # - autologin@$(whoami).service # TODO, or README
        - cockpit.socket
        - rechunker-group-fix.service        
        - seatd.service

  - type: signing
